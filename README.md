# Excel文件内容对比工具 (Chrome插件版)

一个基于Chrome插件的Excel文件对比工具，支持上传两个Excel文件，进行智能字段映射和内容对比，生成带有差异标记的对比结果文件。完全离线运行，保护数据安全。

## 🚀 功能特性

- 📁 **文件上传**: 支持上传两个Excel文件（.xlsx, .xls格式）
- 🔗 **智能字段映射**: 灵活的字段映射配置，支持设置关联字段
- 📊 **历史设置**: 自动保存映射配置，支持沿用历史设置
- ⚙️ **对比规则**: 可配置数值字段的偏差容忍度，支持批量设置
- 📈 **结果生成**: 自动生成对比结果Excel文件，差异部分高亮显示
- 🎨 **现代界面**: 美观的用户界面，步骤清晰，操作简便
- 🔒 **离线使用**: 无需网络连接，完全在本地处理，保护数据隐私
- 💾 **轻量级**: 插件体积小于2MB，安装快速

## 🛠 技术栈

- **前端**: 原生JavaScript + HTML5 + CSS3
- **Excel处理**: SheetJS (xlsx-js-style.min.js)
- **平台**: Chrome Extension Manifest V3
- **存储**: Chrome Storage API

## 📦 安装方法

### 方法一：开发者模式安装（推荐）

1. **打开Chrome扩展程序页面**:
   - 在Chrome地址栏输入 `chrome://extensions/`
   - 或者点击Chrome菜单 → 更多工具 → 扩展程序

2. **启用开发者模式**:
   - 在页面右上角打开"开发者模式"开关

3. **加载插件**:
   - 点击"加载已解压的扩展程序"
   - 选择本项目的根目录（包含manifest.json的文件夹）
   - 点击"选择文件夹"

4. **确认安装**:
   - 插件会出现在扩展程序列表中
   - 可以看到"Excel文件内容对比工具"图标

### 方法二：打包安装

1. **打包插件**:
   - 在Chrome扩展程序页面，点击"打包扩展程序"
   - 选择项目根目录
   - 生成.crx文件

2. **安装.crx文件**:
   - 将.crx文件拖拽到Chrome扩展程序页面
   - 确认安装

## 📖 使用方法

### 第一步：上传文件

1. **启动工具**
   - 点击Chrome工具栏中的插件图标
   - 系统会在新标签页中打开Excel对比工具

2. **选择文件**
   - 点击"主文件"区域，选择第一个Excel文件
   - 点击"副文件"区域，选择第二个Excel文件
   - 支持.xlsx和.xls格式的Excel文件

3. **历史设置选项**
   - 如果之前使用过工具，会显示"沿用历史设置"复选框
   - ✅ **选中**: 在映射表头时自动应用之前保存的字段映射和容忍度设置
   - ❌ **取消选中**: 重新进行字段映射配置，不使用历史设置

4. **解析文件**
   - 点击"解析文件"按钮开始处理

### 第二步：映射表头

1. **字段映射**
   - 系统会自动读取两个文件的列名
   - 为主文件的每个字段选择对应的副文件字段
   - 如果启用了历史设置，会自动填充之前的映射配置

2. **关联字段设置**
   - 必须选择一个关联字段用于行匹配
   - 关联字段在两个文件中必须都存在
   - 关联字段用于确定哪些行需要进行对比
   - 只有关联字段值相同的行才会被对比

3. **数值偏差容忍度设置**
   - **批量设置**: 在表头的"数值偏差容忍度"输入框中输入数值，会应用到所有非关联字段
   - **单独设置**: 为每个字段单独设置容忍度
   - **容忍度作用**: 
     - 数值差异在容忍度范围内：不标记为差异
     - 数值差异超过容忍度：在结果中标红显示
     - 非数值字段：进行精确匹配
   - **清空处理**: 清空批量输入框时，所有非关联字段的容忍度会重置为0

4. **映射验证**
   - 确保至少选择了一个关联字段
   - 检查字段映射的合理性
   - 点击"生成对比文件"继续

### 第三步：生成结果

1. **文件生成**
   - 系统自动进行数据对比
   - 生成包含差异标记的Excel文件
   - 显示生成成功提示

2. **下载结果**
   - 点击"下载对比结果"保存到本地
   - 文件名格式：`对比结果_时间戳.xlsx`

3. **重新开始**
   - 点击"重新开始"进行新的对比
   - 历史设置选项会保持显示状态

## 📊 对比结果格式

生成的Excel文件包含以下结构：

- **第一行**: 主文件字段名（合并单元格显示）
- **第二行**: 三个子列标题
  - 主文件值
  - 副文件值  
  - 差额（数值字段）或差异状态（文本字段）
- **数据行**: 对比结果
  - 相同值：正常显示
  - 差异值：红色背景标记
  - 缺失值：显示为空或特殊标记

## 🔧 功能选项详解

### 沿用历史设置

- **功能**: 自动保存和恢复字段映射配置
- **保存时机**: 每次成功生成对比文件后自动保存
- **保存内容**: 
  - 字段映射关系
  - 关联字段设置
  - 容忍度配置
- **应用逻辑**:
  - 优先匹配相同的字段名
  - 如果历史副文件字段不存在，尝试匹配同名字段
  - 保持容忍度和关联字段设置

### 批量容忍度设置

- **功能**: 一次性为所有非关联字段设置相同的容忍度
- **适用范围**: 仅影响非关联字段
- **输入规则**: 
  - 支持小数（如0.01）
  - 最小值为0
  - 清空时重置所有容忍度为0
- **实时更新**: 输入时立即应用到所有相关字段

### 关联字段

- **作用**: 确定行匹配规则
- **要求**: 必须在两个文件中都存在
- **匹配逻辑**: 只有关联字段值相同的行才会进行对比
- **限制**: 关联字段不能设置容忍度（精确匹配）

## 📁 文件结构

```
excelCompareCrx/
├── manifest.json              # Chrome插件配置文件
├── index.html                # 插件主页面界面
├── index.js                  # 主要业务逻辑
├── styles.css                # 样式文件
├── background.js             # 后台脚本
├── changelog.html            # 更新日志页面
├── libs/
│   └── xlsx-js-style.min.js  # Excel处理库
├── README.md                 # 项目说明
└── CHROME_EXTENSION_README.md # 详细插件说明
```

## ⚠️ 注意事项

1. **文件大小限制**: 建议单个Excel文件不超过5MB，确保处理性能
2. **浏览器兼容性**: 仅支持Chrome浏览器（基于Chrome Extension API）
3. **数据安全**: 所有处理都在本地进行，不会上传到服务器
4. **关联字段**: 必须设置关联字段用于行匹配，且在两个文件中都必须存在
5. **字段映射**: 建议确保字段映射的准确性，避免错误的对比结果
6. **文件格式**: 确保Excel文件包含表头和至少一行数据
7. **内存使用**: 处理大文件时可能占用较多内存，建议关闭其他不必要的标签页


## 🐛 故障排除

### 常见问题

1. **插件无法加载**
   - 检查manifest.json文件是否存在
   - 确认开发者模式已启用
   - 查看Chrome控制台错误信息

2. **文件解析失败**
   - 确认文件格式为.xlsx或.xls
   - 检查文件是否损坏
   - 确认文件包含表头和数据
   - 检查文件是否被其他程序占用

3. **下载失败**
   - 检查浏览器下载权限
   - 确认磁盘空间充足
   - 尝试更换下载位置
   - 检查Chrome下载设置

4. **历史设置不生效**
   - 确认"沿用历史设置"复选框已选中
   - 检查是否存在历史数据
   - 尝试重新生成一次对比文件

### 调试方法

1. **查看控制台**:
   - 右键点击插件图标 → 检查弹出式窗口
   - 查看Console标签页的错误信息

2. **检查存储**:
   - 在控制台中输入 `chrome.storage.local.get(console.log)`
   - 查看插件存储的数据

3. **清除数据**:
   - 在控制台中输入 `chrome.storage.local.clear()`
   - 清除所有历史设置数据

## 📝 更新日志

### v0.2 (2024)
- ✨ 新增历史设置功能，自动保存和恢复映射配置
- ✨ 新增批量容忍度设置功能
- 🐛 修复批量容忍度输入框清空时显示"0"的问题
- 🔧 优化用户界面和交互体验
- 📚 完善文档和使用说明

### v0.1 (2024)
- 🎉 从Python Web应用转换为Chrome插件
- ✨ 实现完全离线的Excel文件对比功能
- 🎨 保持原有的UI设计和交互流程
- 📁 支持本地文件处理和结果下载

## 🔮 开发说明

### 核心技术
- **前端框架**: 原生JavaScript，无外部依赖
- **Excel处理**: SheetJS库，支持多种Excel格式
- **插件架构**: Chrome Extension Manifest V3
- **数据存储**: Chrome Storage API，支持本地数据持久化
- **文件处理**: FileReader API + ArrayBuffer

### 性能优化
- 异步文件处理，避免阻塞UI线程
- 内存管理：及时清理临时数据
- 批量DOM操作，减少重绘次数
- 懒加载：按需加载和渲染数据

### 扩展建议
- 支持更多文件格式（CSV、TSV等）
- 添加数据预览功能
- 支持自定义对比规则
- 添加对比结果统计信息
- 支持导出多种格式的结果文件

## 📄 许可证

MIT License

## 🤝 支持

如有问题或建议，请提交Issue或Pull Request。

---

**注意**: 本工具完全在本地运行，不会收集或传输任何用户数据，请放心使用。